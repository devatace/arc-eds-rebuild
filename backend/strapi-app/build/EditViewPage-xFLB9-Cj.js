import{bK as de,j as e,c_ as ue,k as C,Z as T,F as k,T as y,E as f,bT as F,dl as Q,cM as pe,cN as ge,fU as me,d as B,eG as v,fV as he,bD as q,cp as fe,fW as ye,b0 as xe,bL as Ae,b1 as U,b2 as D,fX as Te,dp as ke,fY as Ee,dq as be,c5 as Ie,aY as z,P as L,v as je,aN as Se,f as m,o as Ce,y as _e,aJ as Pe,s as ve,U as Re,bs as Oe,bt as Me,A as Le,b4 as V}from"./strapi-CGAa_rXE.js";import{b as Ne,c as we,d as $e}from"./apiTokens-CXayQCBo.js";import{A as P}from"./constants-Q2dfXdfa.js";import{a as Ue,b as De,L as Fe,c as Be,F as Ge,A as He}from"./TokenTypeSelect-D5Ajqh5G.js";import{_ as qe}from"./_baseMap-B5Vo6HDd.js";import"./transferTokens-YJBAF-_i.js";import"./index-B1IbP_Hu.js";import"./index-BRVyLNfZ.js";import"./_baseEach-DgzPyvvE.js";const Ve=de.injectEndpoints({endpoints:s=>({getPermissions:s.query({query:()=>"/admin/content-api/permissions",transformResponse:t=>t.data}),getRoutes:s.query({query:()=>"/admin/content-api/routes",transformResponse:t=>t.data})}),overrideExisting:!1}),{useGetPermissionsQuery:Ye,useGetRoutesQuery:We}=Ve,[Ke,Qe]=ue("ApiTokenPermissionsContext"),ze=({children:s,...t})=>e.jsx(Ke,{...t,children:s}),G=()=>Qe("useApiTokenPermissions"),Je=({errors:s={},onChange:t,canEditInputs:n,isCreating:i,values:a={},apiToken:p={},onDispatch:l,setHasChangedPermissions:h})=>{const{formatMessage:c}=C(),g=({target:{value:d}})=>{h(!1),d==="full-access"&&l({type:"SELECT_ALL_ACTIONS"}),d==="read-only"&&l({type:"ON_CHANGE_READ_ONLY"})},E=[{value:"read-only",label:{id:"Settings.tokens.types.read-only",defaultMessage:"Read-only"}},{value:"full-access",label:{id:"Settings.tokens.types.full-access",defaultMessage:"Full access"}},{value:"custom",label:{id:"Settings.tokens.types.custom",defaultMessage:"Custom"}}];return e.jsx(T,{background:"neutral0",hasRadius:!0,shadow:"filterShadow",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,children:e.jsxs(k,{direction:"column",alignItems:"stretch",gap:4,children:[e.jsx(y,{variant:"delta",tag:"h2",children:c({id:"global.details",defaultMessage:"Details"})}),e.jsxs(f.Root,{gap:5,children:[e.jsx(f.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(Ue,{error:s.name,value:a.name,canEditInputs:n,onChange:t})},"name"),e.jsx(f.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(De,{error:s.description,value:a.description,canEditInputs:n,onChange:t})},"description"),e.jsx(f.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(Fe,{isCreating:i,error:s.lifespan,value:a.lifespan,onChange:t,token:p})},"lifespan"),e.jsx(f.Item,{col:6,xs:12,direction:"column",alignItems:"stretch",children:e.jsx(Be,{value:a.type,error:s.type,label:{id:"Settings.tokens.form.type",defaultMessage:"Token type"},onChange:d=>{g({target:{value:d}}),t({target:{name:"type",value:d}})},options:E,canEditInputs:n})},"type")]})]})})};var Xe=Q,Ze=pe,es=qe,ss=ge;function ts(s,t){var n=ss(s)?Xe:es;return n(s,Ze(t))}var ns=ts;const as=F(ns);var is=me;function rs(s){var t=s==null?0:s.length;return t?is(s,1,t):[]}var os=rs;const cs=F(os),ls=s=>{switch(s){case"POST":return{text:"success600",border:"success200",background:"success100"};case"GET":return{text:"secondary600",border:"secondary200",background:"secondary100"};case"PUT":return{text:"warning600",border:"warning200",background:"warning100"};case"DELETE":return{text:"danger600",border:"danger200",background:"danger100"};default:return{text:"neutral600",border:"neutral200",background:"neutral100"}}},ds=B(T)`
  margin: -1px;
  border-radius: ${({theme:s})=>s.spaces[1]} 0 0 ${({theme:s})=>s.spaces[1]};
`,us=({route:s={handler:"Nocontroller.error",method:"GET",path:"/there-is-no-path"}})=>{const{formatMessage:t}=C(),{method:n,handler:i,path:a}=s,p=a?cs(a.split("/")):[],[l="",h=""]=i?i.split("."):[],c=ls(s.method);return e.jsxs(k,{direction:"column",alignItems:"stretch",gap:2,children:[e.jsxs(y,{variant:"delta",tag:"h3",children:[t({id:"Settings.apiTokens.createPage.BoundRoute.title",defaultMessage:"Bound route to"}),"Â ",e.jsx("span",{children:l}),e.jsxs(y,{variant:"delta",textColor:"primary600",children:[".",h]})]}),e.jsxs(k,{hasRadius:!0,background:"neutral0",borderColor:"neutral200",gap:0,children:[e.jsx(ds,{background:c.background,borderColor:c.border,padding:2,children:e.jsx(y,{fontWeight:"bold",textColor:c.text,children:n})}),e.jsx(T,{paddingLeft:2,paddingRight:2,children:as(p,g=>e.jsxs(y,{textColor:g.includes(":")?"neutral600":"neutral900",children:["/",g]},g))})]})]})},ps=()=>{const{value:{selectedAction:s,routes:t}}=G(),{formatMessage:n}=C(),i=s?.split(".")[0];return e.jsx(f.Item,{col:5,background:"neutral150",paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,style:{minHeight:"100%"},direction:"column",alignItems:"stretch",children:s?e.jsx(k,{direction:"column",alignItems:"stretch",gap:2,children:i&&i in t&&t[i].map(a=>a.config.auth?.scope?.includes(s)||a.handler===s?e.jsx(us,{route:a},a.handler):null)}):e.jsxs(k,{direction:"column",alignItems:"stretch",gap:2,children:[e.jsx(y,{variant:"delta",tag:"h3",children:n({id:"Settings.apiTokens.createPage.permissions.header.title",defaultMessage:"Advanced settings"})}),e.jsx(y,{tag:"p",textColor:"neutral600",children:n({id:"Settings.apiTokens.createPage.permissions.header.hint",defaultMessage:"Select the application's actions or the plugin's actions and click on the cog icon to display the bound route"})})]})})},Y=ye`
  background: ${s=>s.theme.colors.primary100};

  #cog {
    opacity: 1;
  }
`,gs=B(T)`
  display: flex;
  justify-content: space-between;
  align-items: center;

  #cog {
    opacity: 0;
    path {
      fill: ${s=>s.theme.colors.primary600};
    }
  }

  /* Show active style both on hover and when the action is selected */
  ${s=>s.$isActive&&Y}
  &:hover {
    ${Y}
  }
`,ms=B.div`
  flex: 1;
  align-self: center;
  border-top: 1px solid ${({theme:s})=>s.colors.neutral150};
`,hs=({controllers:s=[],label:t,orderNumber:n=0,disabled:i=!1})=>{const{value:{onChangeSelectAll:a,onChange:p,selectedActions:l,setSelectedAction:h,selectedAction:c}}=G(),{formatMessage:g}=C(),E=d=>d===c;return e.jsxs(v.Item,{value:`${t}-${n}`,children:[e.jsx(v.Header,{variant:n%2?"primary":"secondary",children:e.jsx(v.Trigger,{children:he(t)})}),e.jsx(v.Content,{children:s?.map(d=>{const R=d.actions.every(r=>l.includes(r.actionId)),_=d.actions.some(r=>l.includes(r.actionId));return e.jsxs(T,{children:[e.jsxs(k,{justifyContent:"space-between",alignItems:"center",padding:4,children:[e.jsx(T,{paddingRight:4,children:e.jsx(y,{variant:"sigma",textColor:"neutral600",children:d?.controller})}),e.jsx(ms,{}),e.jsx(T,{paddingLeft:4,children:e.jsx(q,{checked:!R&&_?"indeterminate":R,onCheckedChange:()=>{a({target:{value:[...d.actions]}})},disabled:i,children:g({id:"app.utils.select-all",defaultMessage:"Select all"})})})]}),e.jsx(f.Root,{gap:4,padding:4,children:d?.actions&&d?.actions.map(r=>e.jsx(f.Item,{col:6,direction:"column",alignItems:"stretch",children:e.jsxs(gs,{$isActive:E(r.actionId),padding:2,hasRadius:!0,children:[e.jsx(q,{checked:l.includes(r.actionId),name:r.actionId,onCheckedChange:()=>{p({target:{value:r.actionId}})},disabled:i,children:e.jsx("span",{style:{overflowWrap:"anywhere"},children:r.action})}),e.jsx("button",{type:"button","data-testid":"action-cog",onClick:()=>h({target:{value:r.actionId}}),style:{display:"inline-flex",alignItems:"center"},children:e.jsx(fe,{id:"cog"})})]})},r.actionId))})]},`${t}.${d?.controller}`)})})]})},fs=({section:s=null,...t})=>e.jsx(T,{children:e.jsx(v.Root,{size:"M",children:s&&s.map((n,i)=>e.jsx(hs,{label:n.label,controllers:n.controllers,orderNumber:i,...t},n.apiId))})}),ys=({...s})=>{const{value:{data:t}}=G(),{formatMessage:n}=C();return e.jsxs(f.Root,{gap:0,shadow:"filterShadow",hasRadius:!0,background:"neutral0",children:[e.jsxs(f.Item,{col:7,paddingTop:6,paddingBottom:6,paddingLeft:7,paddingRight:7,direction:"column",alignItems:"stretch",gap:6,children:[e.jsxs(k,{direction:"column",alignItems:"stretch",gap:2,children:[e.jsx(y,{variant:"delta",tag:"h2",children:n({id:"Settings.apiTokens.createPage.permissions.title",defaultMessage:"Permissions"})}),e.jsx(y,{tag:"p",textColor:"neutral600",children:n({id:"Settings.apiTokens.createPage.permissions.description",defaultMessage:"Only actions bound by a route are listed below."})})]}),t?.permissions&&e.jsx(fs,{section:t?.permissions,...s})]}),e.jsx(ps,{})]})},xs=xe().shape({name:U().max(100).required(D.required.id),type:U().oneOf(["read-only","full-access","custom"]).required(D.required.id),description:U().nullable(),lifespan:Ae().integer().min(0).nullable().defined(D.required.id)});function As(s,t,n,i){for(var a=n-1,p=s.length;++a<p;)if(i(s[a],t))return a;return-1}var Ts=As,ks=Q,Es=Ee,bs=Ts,Is=ke,js=Te,Ss=Array.prototype,W=Ss.splice;function Cs(s,t,n,i){var a=i?bs:Es,p=-1,l=t.length,h=s;for(s===t&&(t=js(t)),n&&(h=ks(s,Is(n)));++p<l;)for(var c=0,g=t[p],E=n?n(g):g;(c=a(h,E,c,i))>-1;)h!==s&&W.call(h,c,1),W.call(s,c,1);return s}var _s=Cs,Ps=_s;function vs(s,t){return s&&s.length&&t&&t.length?Ps(s,t):s}var Rs=vs,Os=be,Ms=Rs,Ls=Os(Ms),Ns=Ls;const K=F(Ns),ws=s=>{const t={allActionsIds:[],permissions:[]};return t.permissions=Object.entries(s).map(([n,i])=>({apiId:n,label:n.split("::")[1],controllers:Object.keys(i.controllers).map(a=>({controller:a,actions:a in i.controllers?i.controllers[a].map(p=>{const l=`${n}.${a}.${p}`;return n.includes("api::")&&t.allActionsIds.push(l),{action:p,actionId:l}}).flat():[]})).flat()})),t},$s={data:{allActionsIds:[],permissions:[]},routes:{},selectedAction:"",selectedActions:[]},Us=(s,t)=>Ie(s,n=>{switch(t.type){case"ON_CHANGE":{n.selectedActions.includes(t.value)?K(n.selectedActions,t.value):n.selectedActions.push(t.value);break}case"SELECT_ALL_IN_PERMISSION":{t.value.every(a=>n.selectedActions.includes(a.actionId))?t.value.forEach(a=>{K(n.selectedActions,a.actionId)}):t.value.forEach(a=>{n.selectedActions.push(a.actionId)});break}case"SELECT_ALL_ACTIONS":{n.selectedActions=[...n.data.allActionsIds];break}case"ON_CHANGE_READ_ONLY":{const i=n.data.allActionsIds.filter(a=>a.includes("find")||a.includes("findOne"));n.selectedActions=[...i];break}case"UPDATE_PERMISSIONS_LAYOUT":{n.data=ws(t.value);break}case"UPDATE_ROUTES":{n.routes={...t.value};break}case"UPDATE_PERMISSIONS":{n.selectedActions=[...t.value];break}case"SET_SELECTED_ACTION":{n.selectedAction=t.value;break}default:return n}}),Ds=()=>{const{formatMessage:s}=C(),{toggleNotification:t}=je(),{state:n}=Se(),i=z(o=>o.admin_app.permissions),[a,p]=m.useState(n?.apiToken?.accessKey?{...n.apiToken}:null),[l,h]=m.useState(!!n?.apiToken?.accessKey),c=m.useRef(null),{trackUsage:g}=Ce(),{allowedActions:{canCreate:E,canUpdate:d,canRegenerate:R}}=_e(i.settings?.["api-tokens"]),[_,r]=m.useReducer(Us,$s),O=Pe("/settings/api-tokens/:id")?.params?.id,x=O==="create",{_unstableFormatAPIError:A,_unstableFormatValidationErrors:H}=ve(),J=Re(),I=Ye(),j=We();m.useEffect(()=>{I.error&&t({type:"danger",message:A(I.error)})},[I.error,A,t]),m.useEffect(()=>{j.error&&t({type:"danger",message:A(j.error)})},[j.error,A,t]),m.useEffect(()=>{I.data&&r({type:"UPDATE_PERMISSIONS_LAYOUT",value:I.data})},[I.data]),m.useEffect(()=>{j.data&&r({type:"UPDATE_ROUTES",value:j.data})},[j.data]),m.useEffect(()=>{a&&(a.type==="read-only"&&r({type:"ON_CHANGE_READ_ONLY"}),a.type==="full-access"&&r({type:"SELECT_ALL_ACTIONS"}),a.type==="custom"&&r({type:"UPDATE_PERMISSIONS",value:a?.permissions}))},[a]),m.useEffect(()=>{g(x?"didAddTokenFromList":"didEditTokenFromList",{tokenType:P})},[x,g]);const{data:b,error:N,isLoading:X}=Ne(O,{skip:!O||x||!!a});m.useEffect(()=>{N&&t({type:"danger",message:A(N)})},[N,A,t]),m.useEffect(()=>{b&&(p(b),b.type==="read-only"&&r({type:"ON_CHANGE_READ_ONLY"}),b.type==="full-access"&&r({type:"SELECT_ALL_ACTIONS"}),b.type==="custom"&&r({type:"UPDATE_PERMISSIONS",value:b?.permissions}))},[b]),m.useEffect(()=>{if(l)return c.current=setTimeout(()=>{h(!1)},3e4),()=>{c.current&&(clearTimeout(c.current),c.current=null)}},[l]);const[Z]=we(),[ee]=$e(),se=async(o,S)=>{g(x?"willCreateToken":"willEditToken",{tokenType:P});try{if(x){const u=await Z({...o,lifespan:o?.lifespan&&o.lifespan!=="0"?parseInt(o.lifespan.toString(),10):null,permissions:o.type==="custom"?_.selectedActions:null});if("error"in u){V(u.error)&&u.error.name==="ValidationError"?S.setErrors(H(u.error)):t({type:"danger",message:A(u.error)});return}t({type:"success",message:s({id:"notification.success.apitokencreated",defaultMessage:"API Token successfully created"})}),g("didCreateToken",{type:u.data.type,tokenType:P}),J(`../api-tokens/${u.data.id.toString()}`,{state:{apiToken:u.data},replace:!0})}else{const u=await ee({id:O,name:o.name,description:o.description,type:o.type,permissions:o.type==="custom"?_.selectedActions:null});if("error"in u){V(u.error)&&u.error.name==="ValidationError"?S.setErrors(H(u.error)):t({type:"danger",message:A(u.error)});return}t({type:"success",message:s({id:"notification.success.apitokenedited",defaultMessage:"API Token successfully edited"})}),g("didEditToken",{type:u.data.type,tokenType:P})}}catch{t({type:"danger",message:s({id:"notification.error",defaultMessage:"Something went wrong"})})}},[te,w]=m.useState(!1),ne=({target:{value:o}})=>{w(!0),r({type:"ON_CHANGE",value:o})},ae=({target:{value:o}})=>{w(!0),r({type:"SELECT_ALL_IN_PERMISSION",value:o})},ie=({target:{value:o}})=>{r({type:"SET_SELECTED_ACTION",value:o})},re=()=>{h(o=>!o),c.current&&(clearTimeout(c.current),c.current=null)},oe={..._,onChange:ne,onChangeSelectAll:ae,setSelectedAction:ie},$=d&&!x||E&&x,ce=!!a?.accessKey;return X?e.jsx(L.Loading,{}):e.jsx(ze,{value:oe,children:e.jsxs(L.Main,{children:[e.jsx(L.Title,{children:s({id:"Settings.PageTitle",defaultMessage:"Settings - {name}"},{name:"API Tokens"})}),e.jsx(Oe,{validationSchema:xs,validateOnChange:!1,initialValues:{name:a?.name||"",description:a?.description||"",type:a?.type,lifespan:a?.lifespan},enableReinitialize:!0,onSubmit:(o,S)=>se(o,S),children:({errors:o,handleChange:S,isSubmitting:u,values:M,setFieldValue:le})=>(te&&M?.type!=="custom"&&le("type","custom"),e.jsxs(Me,{children:[e.jsx(Ge,{title:{id:"Settings.apiTokens.createPage.title",defaultMessage:"Create API Token"},token:a,setToken:p,toggleToken:re,showToken:l,canEditInputs:$,canRegenerate:R,canShowToken:ce,isSubmitting:u,regenerateUrl:"/admin/api-tokens/"}),e.jsx(Le.Content,{children:e.jsxs(k,{direction:"column",alignItems:"stretch",gap:6,children:[a?.accessKey&&l&&e.jsx(e.Fragment,{children:e.jsx(He,{token:a.accessKey,tokenType:P})}),e.jsx(Je,{errors:o,onChange:S,canEditInputs:$,isCreating:x,values:M,apiToken:a,onDispatch:r,setHasChangedPermissions:w}),e.jsx(ys,{disabled:!$||M?.type==="read-only"||M?.type==="full-access"})]})})]}))})]})})},zs=()=>{const s=z(t=>t.admin_app.permissions.settings?.["api-tokens"].read);return e.jsx(L.Protect,{permissions:s,children:e.jsx(Ds,{})})};export{Ds as EditView,zs as ProtectedEditView};
